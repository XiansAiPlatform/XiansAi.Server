### Variables
@baseUrl = http://localhost:5005
@apiVersion = v1
@tenantId = default

# API Key Authentication
# Replace with your actual API key (must start with "sk-Xnai-")
# The API key must belong to a user with SysAdmin or TenantAdmin role
@apiKey = sk-Xnai-aH9m_QKEr797ziDXGcHB90gZ8qEMSx-ps5OBxG12utg

# Note: Replace these with actual values from your tests
@secretId = openai-api-key
@agentId = agent-456
@userId = user-789

### ============================================
### API Key Authentication
### ============================================
# AdminApi uses API key authentication via:
# 1. Authorization header (preferred): Authorization: Bearer <api-key>
# 2. Query parameter (fallback): ?apikey=<api-key>
#
# The API key must belong to a user with SysAdmin or TenantAdmin role.
# Tenant ID is provided via route parameter: /tenants/{tenantId}/secrets
# Use "system" as tenantId for system-scoped secrets (no tenant)

### ============================================
### Secret Vault Management
### ============================================
# Secrets are scoped by:
# - Tenant (required in route, use "system" for system scope)
# - Agent (optional query parameter)
# - User (optional query parameter)

### 1. List Secrets
# Get all secrets for a tenant with optional filtering
# Query parameters:
# - agentId: Filter by agent scope
# - userId: Filter by user scope
# - secretId: Filter by secret ID pattern (supports regex)
# - page: Page number (default: 1)
# - pageSize: Items per page (default: 50, max: 100)
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 2. List Secrets with Filters
# Filter secrets by agent and user scope
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets?agentId={{agentId}}&userId={{userId}}&page=1&pageSize=10
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 3. List System-Scoped Secrets
# Get secrets in the system scope (no tenant)
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/system/secrets
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 4. Get Secret by ID (without value)
# Retrieve a secret without sensitive fields (secretValue, metadata, expireAt)
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 5. Get Secret by ID with Scopes (without value)
# Retrieve a secret with specific agent and user scope
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}?agentId={{agentId}}&userId={{userId}}
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 6. Get Secret by ID (with value)
# Retrieve a secret including sensitive fields
# Use includeValue=true to get secretValue, metadata, and expireAt
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}?includeValue=true
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 7. Get Secret by ID with All Parameters
# Retrieve a secret with scopes and include sensitive value
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}?agentId={{agentId}}&userId={{userId}}&includeValue=true
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 8. Create Tenant-Scoped Secret
# Create a new secret scoped to a tenant only
POST {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "my-api-key",
  "secretValue": "sk-1234567890abcdef",
  "description": "API key for external service",
  "metadata": "{\"environment\":\"production\",\"region\":\"us-east-1\"}",
  "expireAt": "2026-12-31T23:59:59Z"
}

###

### 9. Create Agent-Scoped Secret
# Create a new secret scoped to a specific agent
POST {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "openai-api-key",
  "agentId": "agent-456",
  "secretValue": "sk-openai-1234567890abcdef",
  "description": "OpenAI API key for agent",
  "metadata": "{\"model\":\"gpt-4\"}",
  "expireAt": "2026-12-31T23:59:59Z"
}

###

### 10. Create User-Scoped Secret
# Create a new secret scoped to a specific user within an agent
POST {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "user-token",
  "agentId": "agent-456",
  "userId": "user-789",
  "secretValue": "user-specific-token-12345",
  "description": "User-specific access token"
}

###

### 11. Create System-Scoped Secret
# Create a secret in the system scope (no tenant)
POST {{baseUrl}}/api/{{apiVersion}}/admin/tenants/system/secrets
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "global-api-key",
  "secretValue": "global-secret-value",
  "description": "System-wide API key"
}

###

### 12. Update Secret (tenant-scoped only, no agent/user)
# Update a secret that is scoped ONLY to tenant (agentId=null, userId=null)
# IMPORTANT: If the secret is scoped to agent/user, you MUST provide those as query params!
PATCH {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/my-api-key
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "secretValue": "sk-updated-value",
  "description": "Updated description",
  "metadata": "{\"environment\":\"staging\"}",
  "expireAt": "2027-12-31T23:59:59Z"
}

###

### 13. Update Secret with Agent Scope
# Update a secret that is scoped to a specific agent
# MUST provide ?agentId query parameter to match the existing scope
PATCH {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}?agentId={{agentId}}
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "secretValue": "sk-new-value",
  "description": "Updated description for agent-scoped secret"
}

###

### 14. Update Secret with Agent and User Scope
# Update a secret that is scoped to agent and user
# MUST provide both ?agentId and ?userId query parameters
PATCH {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}?agentId={{agentId}}&userId={{userId}}
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "secretValue": "sk-new-value",
  "description": "Updated description for user-scoped secret"
}

###

### 15. Update Secret (partial - description only)
# Update only the description, preserving other fields
# IMPORTANT: Include scope query parameters if the secret is scoped
PATCH {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/my-api-key
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "description": "Updated description only"
}

###

### 16. Update Secret (change scope)
# Change the agent or user scope of a secret
# Provide CURRENT scope as query params, NEW scope in body
# This will delete the old secret and create a new one with the new scope
PATCH {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/my-api-key
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "agentId": "agent-456",
  "userId": "user-789",
  "description": "Now scoped to specific agent and user"
}

###

### 17. Delete Secret (tenant-scoped only)
# Delete a secret that is scoped ONLY to tenant
DELETE {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/my-api-key
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 18. Delete Secret with Agent Scope
# Delete a secret with specific agent scope
# MUST provide ?agentId query parameter
DELETE {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}?agentId={{agentId}}
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 19. Delete Secret with Agent and User Scope
# Delete a secret with specific agent and user scope
# MUST provide both query parameters
DELETE {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}?agentId={{agentId}}&userId={{userId}}
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 20. Delete System-Scoped Secret
# Delete a secret from the system scope
DELETE {{baseUrl}}/api/{{apiVersion}}/admin/tenants/system/secrets/{{secretId}}
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### ============================================
### Error Scenarios
### ============================================

### 21. Get Non-Existent Secret
# Try to get a secret that doesn't exist (should return 404)
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/non-existent-secret
Authorization: Bearer {{apiKey}}
Accept: application/json

###

### 23. Create Duplicate Secret
# Try to create a secret that already exists with same scope (should return 409)
POST {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "my-api-key",
  "secretValue": "duplicate-test"
}

###

### 24. Update Non-Existent Secret
# Try to update a secret that doesn't exist (should return 404)
PATCH {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/non-existent-secret
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "description": "This should fail"
}

###

### 25. Update Secret with Wrong Scope
# Try to update a secret but provide wrong scope parameters (should return 404)
# This is the common error case!
PATCH {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets/{{secretId}}?agentId=wrong-agent
Authorization: Bearer {{apiKey}}
Content-Type: application/json
Accept: application/json

{
  "description": "This should fail - wrong scope"
}

###

### 26. Invalid Authentication
# Try to access without valid API key (should return 401)
GET {{baseUrl}}/api/{{apiVersion}}/admin/tenants/{{tenantId}}/secrets
Authorization: Bearer invalid-api-key
Accept: application/json

###

