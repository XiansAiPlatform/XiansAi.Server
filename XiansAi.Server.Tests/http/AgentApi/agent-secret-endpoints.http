### Variables
@baseUrl = http://localhost:5005

# Certificate Authentication (Base64-encoded certificate)
# Replace with your actual certificate
# The certificate is validated against the tenant's certificate in the database
@certificate = YOUR_BASE64_ENCODED_CERTIFICATE_HERE

# Note: Replace these with actual values from your tests
@secretId = openai-api-key
@agentId = agent-456
@userId = user-789

### ============================================
### Certificate Authentication
### ============================================
# AgentApi requires certificate authentication via:
# Authorization: Bearer <base64-encoded-certificate>
#
# The certificate must:
# - Be signed by the tenant's CA
# - Not be expired
# - Not be revoked
# - Have client authentication purpose
# - Match the tenant ID in the certificate subject (O=<tenantId>)
#
# The system automatically resolves:
# - Tenant ID from the certificate
# - User ID from the certificate subject
#
# Scopes can be provided via query parameters:
# - agentId: Optional agent scope
# - userId: Optional user scope

### ============================================
### Secret Vault Access
### ============================================
# Secrets are automatically scoped based on the agent's context.
# The tenant ID is resolved from the certificate.
# AgentApi always includes secret values in responses (no includeValue parameter).

### 1. Get Secret by ID
# Retrieve a secret with all fields (including secretValue, metadata, expireAt)
# The system automatically resolves tenant ID from the certificate
GET {{baseUrl}}/api/agent/secrets/{{secretId}}
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 2. Get Secret with Agent Scope
# Retrieve a secret scoped to a specific agent
GET {{baseUrl}}/api/agent/secrets/{{secretId}}?agentId={{agentId}}
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 3. Get Secret with Agent and User Scope
# Retrieve a secret scoped to a specific agent and user
GET {{baseUrl}}/api/agent/secrets/{{secretId}}?agentId={{agentId}}&userId={{userId}}
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 4. List Secrets
# Get all secrets accessible to the agent
# Note: secretValue, metadata, and expireAt are NOT included in list responses
GET {{baseUrl}}/api/agent/secrets
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 5. List Secrets with Pagination
# Get secrets with pagination parameters
GET {{baseUrl}}/api/agent/secrets?page=1&pageSize=10
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 6. List Secrets with Agent Scope
# Get secrets filtered by agent ID
GET {{baseUrl}}/api/agent/secrets?agentId={{agentId}}
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 7. List Secrets with Agent and User Scope
# Get secrets filtered by agent and user ID
GET {{baseUrl}}/api/agent/secrets?agentId={{agentId}}&userId={{userId}}
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 8. Create Tenant-Scoped Secret
# Create a new secret scoped to the tenant only
# Tenant ID is automatically resolved from the certificate
POST {{baseUrl}}/api/agent/secrets
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "my-api-key",
  "secretValue": "sk-1234567890abcdef",
  "description": "API key for external service",
  "metadata": "{\"environment\":\"production\",\"region\":\"us-east-1\"}",
  "expireAt": "2026-12-31T23:59:59Z"
}

###

### 9. Create Agent-Scoped Secret
# Create a new secret scoped to a specific agent
POST {{baseUrl}}/api/agent/secrets
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "openai-api-key",
  "agentId": "agent-456",
  "secretValue": "sk-openai-1234567890abcdef",
  "description": "OpenAI API key for agent",
  "metadata": "{\"model\":\"gpt-4\"}",
  "expireAt": "2026-12-31T23:59:59Z"
}

###

### 10. Create User-Scoped Secret
# Create a new secret scoped to a specific user within an agent
POST {{baseUrl}}/api/agent/secrets
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "user-token",
  "agentId": "agent-456",
  "userId": "user-789",
  "secretValue": "user-specific-token-12345",
  "description": "User-specific access token"
}

###

### 11. Update Secret (all fields)
# Update all fields of an existing secret
# Note: Only provided fields are updated; omitted fields are preserved
PATCH {{baseUrl}}/api/agent/secrets/{{secretId}}
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "secretValue": "sk-updated-value",
  "description": "Updated description",
  "metadata": "{\"environment\":\"staging\"}",
  "expireAt": "2027-12-31T23:59:59Z"
}

###

### 12. Update Secret with Agent Scope
# Update a secret that is scoped to a specific agent
PATCH {{baseUrl}}/api/agent/secrets/{{secretId}}?agentId={{agentId}}
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "secretValue": "sk-new-value",
  "description": "Updated description for agent-scoped secret"
}

###

### 13. Update Secret with Agent and User Scope
# Update a secret that is scoped to agent and user
PATCH {{baseUrl}}/api/agent/secrets/{{secretId}}?agentId={{agentId}}&userId={{userId}}
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "secretValue": "sk-new-value",
  "description": "Updated description for user-scoped secret"
}

###

### 14. Update Secret (partial - description only)
# Update only the description, preserving other fields including secretValue
PATCH {{baseUrl}}/api/agent/secrets/{{secretId}}
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "description": "Updated description only"
}

###

### 15. Update Secret (metadata only)
# Update only the metadata field
PATCH {{baseUrl}}/api/agent/secrets/{{secretId}}
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "metadata": "{\"updated\":true,\"timestamp\":\"2026-01-29T10:00:00Z\"}"
}

###

### 16. Delete Secret
# Delete a tenant-scoped secret
DELETE {{baseUrl}}/api/agent/secrets/{{secretId}}
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 17. Delete Secret with Agent Scope
# Delete a secret scoped to a specific agent
DELETE {{baseUrl}}/api/agent/secrets/{{secretId}}?agentId={{agentId}}
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 18. Delete Secret with Agent and User Scope
# Delete a secret scoped to agent and user
DELETE {{baseUrl}}/api/agent/secrets/{{secretId}}?agentId={{agentId}}&userId={{userId}}
Authorization: Bearer {{certificate}}
Accept: application/json

###

### ============================================
### Error Scenarios
### ============================================

### 19. Get Non-Existent Secret
# Try to get a secret that doesn't exist (should return 404)
GET {{baseUrl}}/api/agent/secrets/non-existent-secret
Authorization: Bearer {{certificate}}
Accept: application/json

###

### 20. Create Duplicate Secret
# Try to create a secret that already exists (should return 400)
POST {{baseUrl}}/api/agent/secrets
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "secretId": "{{secretId}}",
  "secretValue": "duplicate-test"
}

###

### 21. Update Non-Existent Secret
# Try to update a secret that doesn't exist (should return 404)
PATCH {{baseUrl}}/api/agent/secrets/non-existent-secret
Authorization: Bearer {{certificate}}
Content-Type: application/json
Accept: application/json

{
  "description": "This should fail"
}

###

### 22. Invalid Certificate
# Try to access without valid certificate (should return 401)
GET {{baseUrl}}/api/agent/secrets/{{secretId}}
Authorization: Bearer invalid-certificate
Accept: application/json

###

### 23. Missing Authorization
# Try to access without authorization header (should return 401)
GET {{baseUrl}}/api/agent/secrets/{{secretId}}
Accept: application/json

###

### ============================================
### Notes
### ============================================
# 1. AgentApi automatically resolves tenant ID from the certificate
# 2. AgentApi always includes secret values in GET responses (no includeValue parameter)
# 3. List responses never include sensitive fields (secretValue, metadata, expireAt)
# 4. Update operations preserve existing values if fields are not provided
# 5. Scopes (agentId, userId) can be provided as query parameters
# 6. Certificate must be valid and signed by the tenant's CA
###

